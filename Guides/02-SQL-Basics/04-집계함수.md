# 집계함수와 GROUP BY

집계함수는 여러 행의 데이터를 하나의 값으로 요약합니다. 통계와 보고서 작성에 필수적인 기능입니다.

## 1. 주요 집계함수

### COUNT - 개수 세기

```sql
-- 전체 직원 수
SELECT COUNT(*) AS 직원수
FROM employees;
```

**결과:**
```
직원수
------
150
```

### COUNT(컬럼) vs COUNT(*)

```sql
-- NULL을 제외한 이메일 개수
SELECT COUNT(email) AS 이메일_보유자
FROM employees;

-- 모든 행의 개수 (NULL 포함)
SELECT COUNT(*) AS 전체_직원
FROM employees;
```

### SUM - 합계

```sql
-- 전체 급여 합계
SELECT SUM(salary) AS 총급여
FROM employees;
```

**결과:**
```
총급여
------------
850000000
```

### AVG - 평균

```sql
-- 평균 급여
SELECT AVG(salary) AS 평균급여
FROM employees;
```

**결과:**
```
평균급여
---------
5666666.67
```

### MIN, MAX - 최소값, 최대값

```sql
-- 최저 급여와 최고 급여
SELECT
    MIN(salary) AS 최저급여,
    MAX(salary) AS 최고급여
FROM employees;
```

**결과:**
```
최저급여  | 최고급여
----------|----------
3500000   | 12000000
```

## 2. GROUP BY - 그룹별 집계

GROUP BY는 특정 컬럼 기준으로 그룹을 나누어 각 그룹별로 집계합니다.

### 기본 문법

```sql
SELECT 그룹컬럼, 집계함수(컬럼)
FROM 테이블
GROUP BY 그룹컬럼;
```

### 예시: 부서별 인원 수

```sql
-- 각 부서의 직원 수
SELECT
    department AS 부서,
    COUNT(*) AS 인원수
FROM employees
GROUP BY department;
```

**결과:**
```
부서   | 인원수
-------|-------
인사팀 | 15
개발팀 | 45
급여팀 | 12
총무팀 | 8
```

### 예시: 부서별 평균 급여

```sql
-- 부서별 평균 급여
SELECT
    department AS 부서,
    AVG(salary) AS 평균급여,
    COUNT(*) AS 인원수
FROM employees
GROUP BY department
ORDER BY 평균급여 DESC;
```

**결과:**
```
부서   | 평균급여  | 인원수
-------|-----------|-------
개발팀 | 7200000   | 45
인사팀 | 5500000   | 15
급여팀 | 5300000   | 12
총무팀 | 5000000   | 8
```

## 3. GROUP BY 여러 컬럼

여러 컬럼으로 그룹을 나눌 수 있습니다.

```sql
-- 부서별, 직급별 인원 수와 평균 급여
SELECT
    department AS 부서,
    position AS 직급,
    COUNT(*) AS 인원수,
    AVG(salary) AS 평균급여
FROM employees
GROUP BY department, position
ORDER BY department, position;
```

**결과:**
```
부서   | 직급 | 인원수 | 평균급여
-------|------|--------|----------
개발팀 | 사원 | 20     | 5500000
개발팀 | 대리 | 15     | 7000000
개발팀 | 과장 | 10     | 9500000
인사팀 | 사원 | 8      | 4800000
인사팀 | 대리 | 5      | 6000000
```

## 4. HAVING - 그룹 필터링

HAVING은 GROUP BY 결과를 필터링합니다. (WHERE는 그룹화 전에 필터링)

### WHERE vs HAVING

```sql
-- WHERE: 그룹화 전 필터 (개별 행)
-- HAVING: 그룹화 후 필터 (그룹)
```

### 예시: 인원이 10명 이상인 부서만

```sql
SELECT
    department AS 부서,
    COUNT(*) AS 인원수,
    AVG(salary) AS 평균급여
FROM employees
GROUP BY department
HAVING COUNT(*) >= 10;  -- 그룹 조건
```

**결과:**
```
부서   | 인원수 | 평균급여
-------|--------|----------
개발팀 | 45     | 7200000
인사팀 | 15     | 5500000
급여팀 | 12     | 5300000
```

### WHERE와 HAVING 함께 사용

```sql
-- 2020년 이후 입사자 중, 부서별 인원이 5명 이상인 부서
SELECT
    department AS 부서,
    COUNT(*) AS 인원수
FROM employees
WHERE hire_date >= '2020-01-01'  -- 개별 행 필터 (그룹화 전)
GROUP BY department
HAVING COUNT(*) >= 5;  -- 그룹 필터 (그룹화 후)
```

## 5. 실행 순서 이해하기

SQL 실행 순서를 이해하면 WHERE와 HAVING을 올바르게 사용할 수 있습니다.

```sql
SELECT department, COUNT(*) as cnt
FROM employees
WHERE salary >= 5000000
GROUP BY department
HAVING COUNT(*) >= 10
ORDER BY cnt DESC
LIMIT 5;
```

**실행 순서:**
1. `FROM` - 테이블 선택
2. `WHERE` - 개별 행 필터링 (급여 5백만 이상)
3. `GROUP BY` - 그룹화 (부서별)
4. `HAVING` - 그룹 필터링 (인원 10명 이상)
5. `SELECT` - 컬럼 선택
6. `ORDER BY` - 정렬
7. `LIMIT` - 개수 제한

## 6. GROUP BY와 JOIN 함께 사용

```sql
-- 부서별 직원 수와 평균 급여 (부서명 포함)
SELECT
    d.dept_name AS 부서명,
    COUNT(e.emp_id) AS 인원수,
    AVG(e.salary) AS 평균급여,
    SUM(e.salary) AS 총급여
FROM departments d
LEFT JOIN employees e
    ON d.dept_id = e.dept_id
GROUP BY d.dept_id, d.dept_name
ORDER BY 인원수 DESC;
```

**결과:**
```
부서명 | 인원수 | 평균급여  | 총급여
-------|--------|-----------|------------
개발팀 | 45     | 7200000   | 324000000
인사팀 | 15     | 5500000   | 82500000
급여팀 | 12     | 5300000   | 63600000
```

## 7. 유용한 집계 패턴

### 최대값/최소값을 가진 행 찾기

```sql
-- 각 부서에서 급여가 가장 높은 직원
SELECT
    e.department,
    e.emp_name,
    e.salary
FROM employees e
INNER JOIN (
    SELECT department, MAX(salary) as max_salary
    FROM employees
    GROUP BY department
) max_sal
    ON e.department = max_sal.department
    AND e.salary = max_sal.max_salary;
```

### COUNT(DISTINCT) - 고유값 개수

```sql
-- 회사에 몇 개의 직급이 있는지
SELECT COUNT(DISTINCT position) AS 직급종류수
FROM employees;

-- 부서별 서로 다른 직급 수
SELECT
    department,
    COUNT(DISTINCT position) AS 직급종류수
FROM employees
GROUP BY department;
```

### 조건부 집계 (CASE 활용)

```sql
-- 부서별 급여 구간 분포
SELECT
    department AS 부서,
    COUNT(CASE WHEN salary < 5000000 THEN 1 END) AS '5백만_미만',
    COUNT(CASE WHEN salary BETWEEN 5000000 AND 7000000 THEN 1 END) AS '5백만_7백만',
    COUNT(CASE WHEN salary > 7000000 THEN 1 END) AS '7백만_초과'
FROM employees
GROUP BY department;
```

**결과:**
```
부서   | 5백만_미만 | 5백만_7백만 | 7백만_초과
-------|-----------|------------|------------
개발팀 | 5         | 20         | 20
인사팀 | 3         | 10         | 2
```

## 실습 문제

### 문제 1: 기본 집계
전체 직원 수와 평균 급여를 조회하세요.

<details>
<summary>정답 보기</summary>

```sql
SELECT
    COUNT(*) AS 직원수,
    AVG(salary) AS 평균급여
FROM employees;
```
</details>

### 문제 2: 부서별 집계
각 부서의 인원 수를 조회하세요.

<details>
<summary>정답 보기</summary>

```sql
SELECT
    department AS 부서,
    COUNT(*) AS 인원수
FROM employees
GROUP BY department;
```
</details>

### 문제 3: 부서별 급여 통계
각 부서의 최저급여, 최고급여, 평균급여를 조회하세요.

<details>
<summary>정답 보기</summary>

```sql
SELECT
    department AS 부서,
    MIN(salary) AS 최저급여,
    MAX(salary) AS 최고급여,
    AVG(salary) AS 평균급여
FROM employees
GROUP BY department;
```
</details>

### 문제 4: HAVING 사용
평균 급여가 6,000,000 이상인 부서만 조회하세요.

<details>
<summary>정답 보기</summary>

```sql
SELECT
    department AS 부서,
    AVG(salary) AS 평균급여
FROM employees
GROUP BY department
HAVING AVG(salary) >= 6000000;
```
</details>

### 문제 5: WHERE + GROUP BY + HAVING
2020년 이후 입사자 중, 부서별로 그룹화하여,
인원이 5명 이상인 부서의 평균 급여를 조회하세요.

<details>
<summary>정답 보기</summary>

```sql
SELECT
    department AS 부서,
    COUNT(*) AS 인원수,
    AVG(salary) AS 평균급여
FROM employees
WHERE hire_date >= '2020-01-01'
GROUP BY department
HAVING COUNT(*) >= 5
ORDER BY 평균급여 DESC;
```
</details>

### 문제 6: JOIN + GROUP BY
부서 테이블과 조인하여, 부서명과 각 부서의 총 급여를 조회하세요.

<details>
<summary>정답 보기</summary>

```sql
SELECT
    d.dept_name AS 부서명,
    SUM(e.salary) AS 총급여
FROM departments d
LEFT JOIN employees e
    ON d.dept_id = e.dept_id
GROUP BY d.dept_id, d.dept_name
ORDER BY 총급여 DESC;
```
</details>

## 실무 활용 예시

### 월별 입사자 통계

```sql
-- 월별 입사자 수
SELECT
    DATE_TRUNC('month', hire_date) AS 입사월,
    COUNT(*) AS 입사자수
FROM employees
GROUP BY DATE_TRUNC('month', hire_date)
ORDER BY 입사월;
```

### 부서별 재직 기간 통계

```sql
-- 부서별 평균 재직 기간
SELECT
    department AS 부서,
    AVG(CURRENT_DATE - hire_date) AS 평균재직일수,
    COUNT(*) AS 인원수
FROM employees
WHERE resign_date IS NULL  -- 재직 중인 직원만
GROUP BY department;
```

## 핵심 요약

✅ **COUNT**: 개수 세기 (COUNT(*), COUNT(컬럼))
✅ **SUM, AVG**: 합계, 평균
✅ **MIN, MAX**: 최소값, 최대값
✅ **GROUP BY**: 그룹별 집계
✅ **HAVING**: 그룹 필터링 (WHERE는 개별 행 필터링)
✅ **실행 순서**: FROM → WHERE → GROUP BY → HAVING → SELECT → ORDER BY

## 다음 단계

집계함수까지 배웠다면, 이제 실습 예제로 배운 내용을 종합적으로 연습해봅시다!

👉 **[실습 예제로 이동](./05-실습-예제.md)**
